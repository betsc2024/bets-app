# Database Updates - April 1, 2025

## Analysis Type Changes

### Schema Updates
1. Removed constraint to `attributes` table that ensured valid analysis types:
```sql
ALTER TABLE attributes 
DROP CONSTRAINT IF EXISTS valid_analysis_type;
```

### Company Standard Check
- Maintained existing constraint `company_standard_check` which ensures:
  - If `company_id` is NULL, then `is_industry_standard` must be true
  - If `company_id` is not NULL, then `is_industry_standard` must be false

### Analysis Type Management
- Analysis types are managed through a flexible junction table `attribute_analysis_types`
- Multiple analysis types can be assigned to a single attribute
- No restrictions on analysis type names, allowing for custom types
- Analysis types are managed entirely through the UI with add/delete capabilities
- No predefined analysis types - all types are user-defined

```sql
-- Drop existing table and recreate with new structure
DROP TABLE IF EXISTS attribute_analysis_types CASCADE;

-- Create the attribute_analysis_types junction table
CREATE TABLE attribute_analysis_types (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    attribute_id UUID REFERENCES attributes(id) ON DELETE CASCADE,
    analysis_type VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(attribute_id, analysis_type)
);

-- Create index for better query performance
CREATE INDEX idx_attribute_analysis_types_attribute_id ON attribute_analysis_types(attribute_id);
CREATE INDEX idx_attribute_analysis_types_type ON attribute_analysis_types(analysis_type);

-- Query to get all analysis types for an attribute
SELECT a.name as attribute_name, array_agg(aat.analysis_type) as analysis_types
FROM attributes a
LEFT JOIN attribute_analysis_types aat ON a.id = aat.attribute_id
GROUP BY a.id, a.name;
```

The above schema provides:
1. Complete flexibility - no predefined analysis types
2. Many-to-many relationship between attributes and analysis types
3. Automatic timestamps for auditing
4. Indexes for better query performance
5. Prevents duplicate analysis types per attribute (via UNIQUE constraint)

### UI Updates
- Analysis type input is now a free-form text field
- Users can add new analysis types through the UI
- Analysis types are displayed in alphabetical order
- Analysis type list is dynamically fetched from existing attributes
